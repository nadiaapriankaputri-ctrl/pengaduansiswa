<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengaduan Siswa (Lokal)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Container Utama -->
    <div id="app" class="container mx-auto p-4 max-w-4xl">

        <!-- Halaman Login -->
        <div id="loginPage">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto mt-12">
                <h1 class="text-3xl font-bold text-center text-gray-700 mb-2">Sistem Pengaduan Siswa</h1>
                <p class="text-center text-gray-500 mb-8">Silakan masuk untuk melanjutkan</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="studentName" class="block text-sm font-medium text-gray-600">Nama Lengkap</label>
                        <input type="text" id="studentName" placeholder="Contoh: Budi Sanjaya" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="studentClass" class="block text-sm font-medium text-gray-600">Kelas</label>
                        <select id="studentClass" class="form-select mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Opsi kelas akan di-generate oleh JavaScript -->
                        </select>
                    </div>
                    <!-- Kolom Password Admin (Tersembunyi) -->
                    <div id="adminPasswordContainer" class="hidden pt-2">
                        <label for="adminPassword" class="block text-sm font-medium text-gray-600">Password Admin</label>
                        <input type="password" id="adminPassword" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <p id="passwordError" class="text-red-600 text-sm mt-1 hidden">Password yang Anda masukkan salah.</p>
                    </div>
                </div>
                
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="loginStudentBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Masuk sebagai Siswa
                    </button>
                    <button id="loginAdminBtn" class="w-full bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                        Masuk sebagai Admin
                    </button>
                </div>
            </div>
        </div>

        <!-- Dasbor Siswa -->
        <div id="studentDashboard" class="hidden">
            <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Dasbor Siswa</h2>
                    <p id="welcomeMessage" class="text-gray-600"></p>
                </div>
                <button id="logoutBtnStudent" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600 transition">Keluar</button>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Laporan Saya</h3>
                    <button id="newReportBtn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-600 transition">Buat Laporan Baru</button>
                </div>
                <div id="studentReports" class="space-y-4">
                    <!-- Laporan siswa akan ditampilkan di sini -->
                </div>
            </div>
        </div>

        <!-- Dasbor Admin -->
        <div id="adminDashboard" class="hidden">
             <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Panel Admin</h2>
                    <p class="text-gray-600">Tinjau dan kelola semua laporan yang masuk.</p>
                </div>
                <button id="logoutBtnAdmin" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600 transition">Keluar</button>
            </div>
             <div class="bg-white p-6 rounded-xl shadow-md">
                 <h3 class="text-xl font-semibold mb-4">Semua Laporan Masuk</h3>
                 <div id="adminReports" class="space-y-4">
                     <!-- Semua laporan akan ditampilkan di sini -->
                 </div>
            </div>
        </div>
        
        <!-- Modal Form Laporan Baru -->
        <div id="reportModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg transform transition-all" id="reportModalContent">
                <h2 class="text-2xl font-bold mb-6">Buat Laporan Pengaduan</h2>
                <form id="reportForm" class="space-y-4">
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Kategori</label>
                        <select id="category" name="category" required class="form-select mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Fasilitas">Fasilitas & Infrastruktur</option>
                            <option value="Kebersihan">Kebersihan & Lingkungan</option>
                            <option value="Pembelajaran">Proses Belajar Mengajar</option>
                            <option value="Perundungan">Perundungan (Bullying)</option>
                            <option value="Keamanan">Keamanan</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Deskripsi Laporan</label>
                        <textarea id="description" name="description" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Jelaskan laporan Anda secara detail..."></textarea>
                    </div>
                    <div>
                        <label for="media" class="block text-sm font-medium text-gray-700">Lampirkan Foto/Video (Opsional)</label>
                        <input type="file" id="media" name="media" accept="image/*,video/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <img id="imagePreview" src="" alt="Pratinjau Gambar" class="hidden mt-4 rounded-md max-h-40 w-auto"/>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancelReportBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition">Batal</button>
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition flex items-center">
                            <span id="submitText">Kirim Laporan</span>
                            <div id="submitLoader" class="loader w-4 h-4 rounded-full border-2 border-gray-200 ml-2 hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div> <!-- End #app -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State aplikasi
            let currentUser = null;

            // Elemen-elemen DOM
            const loginPage = document.getElementById('loginPage');
            const studentDashboard = document.getElementById('studentDashboard');
            const adminDashboard = document.getElementById('adminDashboard');
            const reportModal = document.getElementById('reportModal');
            const studentNameInput = document.getElementById('studentName');
            const studentClassSelect = document.getElementById('studentClass');
            const imagePreview = document.getElementById('imagePreview');
            const mediaInput = document.getElementById('media');
            const adminPasswordContainer = document.getElementById('adminPasswordContainer');
            const adminPasswordInput = document.getElementById('adminPassword');
            const passwordError = document.getElementById('passwordError');

            // --- FUNGSI DATA LOCALSTORAGE ---
            const getAllReports = () => {
                const reports = localStorage.getItem('studentReports');
                return reports ? JSON.parse(reports) : [];
            };

            const saveAllReports = (reports) => {
                localStorage.setItem('studentReports', JSON.stringify(reports));
            };

            // --- FUNGSI UTILITAS ---
            const showPage = (page) => {
                loginPage.classList.add('hidden');
                studentDashboard.classList.add('hidden');
                adminDashboard.classList.add('hidden');
                page.classList.remove('hidden');
            };
            
            const getStatusBadge = (status) => {
                switch (status) {
                    case 'Terkirim': return `<span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800">${status}</span>`;
                    case 'Diproses': return `<span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full bg-yellow-100 text-yellow-800">${status}</span>`;
                    case 'Selesai': return `<span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">${status}</span>`;
                    case 'Ditolak': return `<span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full bg-red-100 text-red-800">${status}</span>`;
                    default: return `<span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-800">${status}</span>`;
                }
            };

            const generateClassOptions = () => {
                const grades = ['X', 'XI', 'XII'];
                const majors = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
                let options = '<option value="">-- Pilih Kelas --</option>';
                grades.forEach(grade => {
                    majors.forEach(major => {
                        const className = `${grade}${major}`;
                        options += `<option value="${className}">${className}</option>`;
                    });
                });
                studentClassSelect.innerHTML = options;
            };

            const generateReportCode = () => {
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const randomChars = Math.random().toString(36).substring(2, 5).toUpperCase();
                return `LPR-${year}${month}${day}-${randomChars}`;
            };
            
            // --- LOGIKA APLIKASI ---
            const handleLogin = (role) => {
                const name = studentNameInput.value.trim();
                const studentClass = studentClassSelect.value;
                passwordError.classList.add('hidden');

                if (role === 'admin') {
                    adminPasswordContainer.classList.remove('hidden');
                    const password = adminPasswordInput.value;
                    if (password !== 'smanida1223') { // Ganti password jika perlu
                        if (password) passwordError.classList.remove('hidden');
                        return;
                    }
                } else {
                    adminPasswordContainer.classList.add('hidden');
                }
                
                if (!name) { alert('Nama tidak boleh kosong.'); return; }
                if (role === 'student' && !studentClass) { alert('Silakan pilih kelas Anda.'); return; }

                currentUser = { 
                    name, 
                    class: studentClass, 
                    role,
                    uid: crypto.randomUUID() // ID unik untuk setiap sesi login siswa
                };
                
                sessionStorage.setItem('user', JSON.stringify(currentUser));

                if (role === 'student') {
                    document.getElementById('welcomeMessage').innerText = `Selamat datang, ${name} dari kelas ${studentClass}`;
                    showPage(studentDashboard);
                    renderStudentReports();
                } else {
                    showPage(adminDashboard);
                    renderAdminReports();
                }
            };

            const handleLogout = () => {
                currentUser = null;
                sessionStorage.removeItem('user');
                studentNameInput.value = '';
                studentClassSelect.value = '';
                adminPasswordInput.value = '';
                adminPasswordContainer.classList.add('hidden');
                passwordError.classList.add('hidden');
                showPage(loginPage);
            };
            
            const renderStudentReports = () => {
                const container = document.getElementById('studentReports');
                const allReports = getAllReports();
                const myReports = allReports.filter(report => report.studentUid === currentUser.uid);
                
                myReports.sort((a, b) => b.createdAt - a.createdAt);

                if (myReports.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">Belum ada laporan yang dibuat.</p>`;
                    return;
                }
                container.innerHTML = myReports.map(report => `
                    <div class="border border-gray-200 p-4 rounded-lg hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-700">${report.category}</p>
                                <p class="text-xs font-mono text-gray-500 mt-1">${report.reportCode || 'N/A'}</p>
                            </div>
                            ${getStatusBadge(report.status)}
                        </div>
                        <p class="mt-2 text-gray-600">${report.description}</p>
                        <p class="text-right text-sm text-gray-500 mt-2">${new Date(report.createdAt).toLocaleString('id-ID')}</p>
                    </div>
                `).join('');
            };
            
            const renderAdminReports = () => {
                const container = document.getElementById('adminReports');
                const allReports = getAllReports();
                allReports.sort((a, b) => b.createdAt - a.createdAt);

                if (allReports.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">Tidak ada laporan yang masuk.</p>`;
                    return;
                }
                container.innerHTML = allReports.map(report => `
                    <div class="border border-gray-200 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                            <div>
                                <p class="font-bold">${report.studentName}</p>
                                <p class="text-sm text-gray-500">Kelas: ${report.studentClass}</p>
                                <p class="text-xs font-mono text-gray-500 mt-1">${report.reportCode || 'N/A'}</p>
                                <p class="text-sm text-gray-500 mt-1">${new Date(report.createdAt).toLocaleString('id-ID')}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700">${report.category}</p>
                                <p class="mt-1 text-gray-600">${report.description}</p>
                            </div>
                            <div class="flex flex-col items-start md:items-end gap-2">
                                ${getStatusBadge(report.status)}
                                <select data-id="${report.id}" class="status-changer form-select text-sm mt-2 block w-full md:w-auto px-3 py-1 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="Terkirim" ${report.status === 'Terkirim' ? 'selected' : ''}>Terkirim</option>
                                    <option value="Diproses" ${report.status === 'Diproses' ? 'selected' : ''}>Diproses</option>
                                    <option value="Selesai" ${report.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                                    <option value="Ditolak" ${report.status === 'Ditolak' ? 'selected' : ''}>Ditolak</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                document.querySelectorAll('.status-changer').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const reportId = e.target.dataset.id;
                        const newStatus = e.target.value;
                        const reports = getAllReports();
                        const reportIndex = reports.findIndex(r => r.id == reportId);
                        if (reportIndex > -1) {
                            reports[reportIndex].status = newStatus;
                            saveAllReports(reports);
                            renderAdminReports(); // Re-render untuk menampilkan badge yang diperbarui
                        }
                    });
                });
            };
            
            const handleFormSubmit = (e) => {
                e.preventDefault();
                document.getElementById('submitText').classList.add('hidden');
                document.getElementById('submitLoader').classList.remove('hidden');

                const newReport = {
                    id: Date.now(),
                    studentName: currentUser.name,
                    studentClass: currentUser.class,
                    studentUid: currentUser.uid,
                    category: e.target.category.value,
                    description: e.target.description.value,
                    status: "Terkirim",
                    createdAt: Date.now(),
                    reportCode: generateReportCode()
                };
                
                const reports = getAllReports();
                reports.push(newReport);
                saveAllReports(reports);

                setTimeout(() => { // Simulasi loading
                    reportModal.classList.add('hidden');
                    e.target.reset();
                    imagePreview.classList.add('hidden');
                    document.getElementById('submitText').classList.remove('hidden');
                    document.getElementById('submitLoader').classList.add('hidden');
                    renderStudentReports();
                }, 500);
            };

            // --- EVENT LISTENERS ---
            document.getElementById('loginStudentBtn').addEventListener('click', () => handleLogin('student'));
            document.getElementById('loginAdminBtn').addEventListener('click', () => handleLogin('admin'));
            document.getElementById('logoutBtnStudent').addEventListener('click', handleLogout);
            document.getElementById('logoutBtnAdmin').addEventListener('click', handleLogout);

            document.getElementById('newReportBtn').addEventListener('click', () => reportModal.classList.remove('hidden'));
            document.getElementById('cancelReportBtn').addEventListener('click', () => {
                reportModal.classList.add('hidden');
                document.getElementById('reportForm').reset();
                imagePreview.classList.add('hidden');
            });
            document.getElementById('reportForm').addEventListener('submit', handleFormSubmit);

            mediaInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.src = event.target.result;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.classList.add('hidden');
                }
            });

            // --- INISIALISASI APLIKASI ---
            const checkSession = () => {
                const savedUser = sessionStorage.getItem('user');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser.role === 'student') {
                        document.getElementById('welcomeMessage').innerText = `Selamat datang kembali, ${currentUser.name} dari kelas ${currentUser.class}`;
                        showPage(studentDashboard);
                        renderStudentReports();
                    } else {
                        showPage(adminDashboard);
                        renderAdminReports();
                    }
                } else {
                    showPage(loginPage);
                }
            };
            
            generateClassOptions();
            checkSession();
        });
    </script>
</body>
</html>

